# 协议

> 计网各种协议的基本流程和作用汇总

## 数据链路层

> 数据链路层使用的信道主要有两种类型：
>
> 1. 点对点信道
> 2. 广播信道

### PPP 协议

> 点对点信道最常用的协议
>
> 就是用户计算机和 ISP 进行通信时所使用的数据链路层协议

三个组成部分

1. 一个将 IP 数据报封装到串行链路的方法
2. 一种链路配置协议 LCP，使两端可以在链路建立时进行配置
3. 一套网络控制协议 NCP，允许在链路建立后进行网络层协议的配置

基本工作流程如下

1. 用户拨号接入 ISP，建立了一条从用户个人电脑到 ISP 的物理链路
2. 用户个人电脑想 ISP 发送一系列的链路控制协议 LCP 分组（封装为多个 PPP 帧），建立 LCP 链接，配置了一些 PPP 参数
3. 网络层配置，网络控制协议 NCP 给用户个人电脑分配了一个临时 IP 地址，此时用户个人电脑就称为互联网上的一个有 IP 地址的主机了
4. 用户通信完毕，NCP 释放网络层连接（收回 IP 地址）
5. LCP 释放链路层连接，最后断开物理链路

### CSMA/CD 协议

> 早期以太网将许多计算机连接到一根总线上，而总线的特地是：当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据，这就是广播通信方式（属于同一个冲突域）
>
> 以太网采用的是无连接的工作方式，也就是不可靠交付
>
> 以太网发送的数据都使用曼彻斯特编码
>
> 以太网不需要使用帧结束定界符，也不需要使用字节插入来保证透明传输
>
> 总线上只要有一台计算机在发送数据，总线的资源就被占用，也就是说总线在同一时间只能允许一台计算机发送数据，否则就会产生干扰，使得发送数据被破坏。
>
> 为了解决这个问题，以太网采用了一种称为 CSMA/CD 的协议，它的基本原理是：在发送数据之前先侦听信道，如果信道空闲就发送，如果信道忙就等待，如果发送过程中检测到信道忙就停止发送，等待一段时间后再发送。

### STP 协议

> 生成树协议，用于解决交换机自学习生成交换表时的环路问题

## 网络层

### ARP 协议

> 地址解析协议，用于将已知的 IP 地址解析为 MAC 地址
>
> ARP 分组封装在以太网中
>
> 每个主机都设有一个 ARP 高速缓存

基本查询流程

1. 查询主机 A 的 ARP 高速缓存，如果有则直接使用
2. 如果没有，则 ARP 进程在本局域网上广播发送一个 ARP 请求分组，具体内容为：“我的 IP 地址是 xxx.xxx.xxx.xxx,MAC 地址是 xx-xx-xx-xx-xx-xx，我想知道 IP 地址为 xxx.xxx.xxx.xxx 主机的 MAC 地址”
3. 在本局域网的所有主机上运行的 ARP 进程都会收到此 ARP 请求分组，如果主机 IP 和查询请求一致，就收下这个请求，并发送 ARP 响应分组（单播非广播），并将主机 A 的 MAC 地址写入 ARP 高速缓存
4. 主机 A 收到主机 B 的 ARP 响应，将主机 B 的 MAC 地址写入 ARP 高速缓存
5. 如果第 3 步中没有主机收到请求，那么主机 A 就把 ARP 请求分组发送给默认网关，然后由默认网关转发给外网

### ICMP 协议

> 为了更有效的转发 IP 数据报和提高交付成功的机会
>
> ICMP 用于在主机和路由器之间传递控制消息，提供差错情况和有关异常情况的报告
>
> ICMP 分组封装在 IP 数据报中，IP 数据报封装在以太网中

以下都是互联网的路由选择协议，规定了互联网中有关的路由器应该如何互相交换信息并生成路由表

### RIP

> 内部网关协议，用于在小型网络中进行路由选择
>
> 基于 UDP
>
> 是一种基于距离向量的路由选择协议，最大的优点就是简单
>
> 最大距离为 15，可见 RIP 只能用于小型网络

1. 仅和相邻路由器交换信息，并且交换的是路由器的整个路由表
2. 按固定的时间间隔交换路由信息

缺点是坏消息传播的很慢

### OSPF

> 开放最短路径优先协议，用于在大型网络中进行路由选择
>
> 底层算法使用的是 Dijkstra 提出的最短路径算法 SPF
>
> 最主要的特征是使用链路状态协议

1. 通过洪泛法向自洽系统中的所有路由器发送信息，A 发给 B，B 又发给 C.....
2. 发送的信息就是与本路由器相邻的所有路由器的链路状态信息（本路由器和哪些路由器相邻，以及该链路的度量（人为定义））
3. 链路状态变化或每隔一段时间，路由器向所有路由器用洪泛法发送链路状态信息

使用 OSPF 的自洽系统中，所有路由器都知道全网的拓扑结构图

并且 OSPF 的更新过程收敛的很快

为了使 OSPF 能够用于规模很大的网络，OSPF 将网络划分为若干个区域，每个区域都有一个区域内的路由器，这些路由器都知道本区域的拓扑结构图，但是不知道其他区域的拓扑结构图

OSPF 允许管理员给每条路由指派不同的代价

### BGP

> 外部网关协议，用于在自洽系统之间进行路由选择
>
> 由于不同自洽系统使用不同的内部网关协议，所以 BGP 不能使用 RIP 和 OSPF 的路由信息，而是仅仅传递目的地网络的可达性信息
>
> BGP 只是力求选择出一条能够到达目的网络前缀且代价较小的路由，而不是选择一条最佳路由
>
> BGP 采用的是路径向量路由选择协议
>
> BGP 并非只运行在 AS 之间，而且也运行在 AS 内部

## 传输层

## 应用层

### DNS

> 域名系统 DNS，用于把便于人们使用的机器名字转换为 IP 地址
>
> 端口号 53
>
> 需要注意的是 dns 请求是以 UDP 用户数据报的形式发送的

基本查询流程

1. 客户端发送 dns 查询请求
2. 首先检查主机 dns 缓存，如果有则直接使用
3. 向本地 dns 服务器发送 dns 查询请求（一般为递归查询），查询到则直接返回
4. 向根域名服务器发送 dns 查询请求，根域名服务器会返回对应的顶级域名，本地 dns 服务器再向顶级域名服务器发送 dns 查询请求，如果查询到则直接返回，否则告诉本地 dns 服务器应该向对应二级域名服务器进行查询
5. 迭代查询，知道查询到 dns 所需 ip 地址为止

### FTP

> 文件传送协议，基于 TCP，用于在互联网上进行文件传输，主要用于减少在不同操作系统下处理文件的不兼容性
>
> 端口号 21

FTP 使用客户服务器方式，FTP 的服务器由两大部分组成，一个主进程，负责接受新的请求；另外还有若干从属进程，负责处理单个请求

在进行文件传输时，FTP 的客户和服务器之间要建立两个并行的 TCP 连接：“控制连接”和“数据连接”。

注意控制连接用的端口号是 20 端口

### TELNET

> 远程终端协议，会与 TCP，明文传输，不安全

### HTTP

> 超文本传输协议，定义了浏览器怎么想万维网服务器请求万维网文档，以及服务器怎么样把文档传送给浏览器

### SMTP 和 POP3 和 IMAP

> 邮件发送协议 SMTP（端口 25），邮件读取协议 POP3,IMAP
>
> SMTP 用于用户代理向邮件服务器发送邮件或再邮件服务器之间发送邮件
>
> POP3 则用于用户代理从邮件服务器中读取文件，特点是只要用户从 POP3 服务器中读取了邮件，POP3 服务器就把该邮件删除
>
> IMAP 协议也用于用户代理从邮件服务器中读取邮件，只不过它比 POP3 要复杂的多，用户可以在自己计算机上操纵邮件服务器的邮箱，并且在用户未发出删除邮件的命令之前，IMAP 服务器邮箱中的邮件一直保存着
>
> 注意邮件服务器必须能同时充当客户和服务器

### DHCP

> 动态主机配置协议，用于自动分配 IP 地址
>
> 基于 UDP
