# ä½œä¸š 13

> å‚è€ƒ SysY è¯­è¨€æ–‡æ³•ï¼Œè®¾è®¡ç±» C è¯­è¨€é£æ ¼çš„æ•°ç»„æ–‡æ³•ï¼ŒåŠå…¶å¯¹åº”çš„è¯­ä¹‰åŠ¨ä½œç¨‹åº
> æ³¨æ„ï¼š
> ï¼ˆ1ï¼‰è¯´æ˜ç¬¦å·è¡¨ç»“æ„ï¼Œå’Œæ•°ç»„å£°æ˜å¯¹åº”çš„å¡«è¡¨åŠ¨ä½œ
> ï¼ˆ2ï¼‰ç±» C é£æ ¼ä¸è€ƒè™‘è¿è¡Œæ—¶è¶Šç•Œæ£€æŸ¥ï¼Œä½†éœ€è¦æ•°ç»„ä½¿ç”¨æ—¶ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ç»´æ•°ä¸ªæ•°
> ï¼ˆ3ï¼‰ä¸ä½¿ç”¨æ•°ç»„æ¨¡ç‰ˆï¼Œæ— éœ€è®¡ç®—æ•°ç»„æ¨¡ç‰ˆæ‰€éœ€çš„ P(i)å’Œ RC

å…·ä½“æ–‡æ³•å¦‚ä¸‹

```txt
<type-specifier> ::= int | float | double | char | ...

<declarator> ::= <identifier> | <declarator> '[' <constant-expression> ']'

<constant-expression> ::= <integer-constant>

<statement> ::= <expression-statement> | ...

<expression-statement> ::= <expression> ';'

<expression> ::= <assignment-expression> | ...

<assignment-expression> ::= <conditional-expression> | <unary-expression> <assignment-operator> <assignment-expression>

<unary-expression> ::= <postfix-expression> | ...

<postfix-expression> ::= <primary-expression> | <postfix-expression> '[' <expression> ']'

<primary-expression> ::= <identifier> | <constant> | ...

<assignment-operator> ::= '='

<constant> ::= <integer-constant>

<integer-constant> ::= <digit>+

<digit> ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
```

```cpp
#define MAX_SYMBOLS 1000
#define MAX_DIMENSIONS 10

typedef struct {
    char name[32];
    int type;
    int dimensions[MAX_DIMENSIONS];
    int num_dimensions;
    int element_size;
    int size;
    int offset;
} symbol_t;

symbol_t symbol_table[MAX_SYMBOLS];
int num_symbols = 0;
// å°†æ•°ç»„ç¬¦å·è¡¨é¡¹æ·»åŠ åˆ°ç¬¦å·è¡¨ä¸­ï¼Œå¹¶ä¸ºæ•°ç»„åˆ†é…å†…å­˜ç©ºé—´
int add_symbol(char *name, int type, int *dimensions, int num_dimensions) {
    symbol_t symbol;
    strcpy(symbol.name, name);
    symbol.type = type;
    symbol.num_dimensions = num_dimensions;
    symbol.element_size = type == INT ? sizeof(int) : sizeof(float);
    symbol.size = symbol.element_size;
    for (int i = 0; i < num_dimensions; i++) {
        symbol.dimensions[i] = dimensions[i];
        symbol.size *= dimensions[i];
    }
    symbol.offset = 0;
    for (int i = 0; i < num_symbols; i++) {
        if (strcmp(symbol_table[i].name, name) == 0) {
            return -1;
        }
        symbol.offset += symbol_table[i].size;
    }
    symbol_table[num_symbols++] = symbol;
    return 0;
}

symbol_t *find_symbol(char *name) {
    for (int i = 0; i < num_symbols; i++) {
        if (strcmp(symbol_table[i].name, name) == 0) {
            return &symbol_table[i];
        }
    }
    return NULL;
}
// æ£€æŸ¥æ•°ç»„çš„ç»´æ•°æ˜¯å¦æ­£ç¡®
int check_array_dimensions(symbol_t *symbol, int *dimensions, int num_dimensions) {
    if (symbol->num_dimensions != num_dimensions) {
        return -1;
    }
    for (int i = 0; i < num_dimensions; i++) {
        if (symbol->dimensions[i] != dimensions[i]) {
            return -1;
        }
    }
    return 0;
}

int main() {
    int dimensions[] = {10, 20};
    add_symbol("a", INT, dimensions, 2);
    symbol_t *symbol = find_symbol("a");
    int dimensions2[] = {10, 20};
    if (check_array_dimensions(symbol, dimensions2, 2) != 0) {
        printf("Error: array dimensions do not match\n");
        exit(1);
    }
    printf("Array size: %d\n", symbol->size);
    return 0;
}
```

> å‚è€ƒ C è¯­è¨€æ–‡æ³•ï¼Œè®¾è®¡ç»“æ„ä½“ï¼ˆstructï¼‰å£°æ˜çš„æ–‡æ³•ï¼ŒåŠå…¶å¯¹åº”çš„è¯­ä¹‰åŠ¨ä½œç¨‹åºï¼›ä»¥åŠå£°æ˜ç»“æ„ä½“å˜é‡çš„æ–‡æ³•å’Œå¤„ç†åŠ¨ä½œã€‚
> æ³¨æ„ï¼š
> ï¼ˆ1ï¼‰è¯´æ˜ç¬¦å·è¡¨ç»“æ„ï¼Œå’Œ struct å£°æ˜ã€struct ç±»å‹å˜é‡å£°æ˜çš„å¯¹åº”å¡«è¡¨åŠ¨ä½œ
> ï¼ˆ2ï¼‰æ€è€ƒè‡ªå®šä¹‰ç±»å‹çš„å¡«å†™æ˜¯å¦éœ€è¦å†™å…¥ç¬¦å·è¡¨ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
> ï¼ˆ3ï¼‰è‡³å°‘ä¸¾å‡ºä¸€ä¸ªä¾‹å­ï¼ˆåŒ…æ‹¬ struct å®šä¹‰å’Œå˜é‡å£°æ˜ï¼‰ï¼Œè¯´æ˜å¯¹åº”çš„æ“ä½œã€‚

å…·ä½“ç»“æ„ä½“å£°æ˜å’Œç»“æ„ä½“å˜é‡çš„æ–‡æ³• ğŸ‘‡ğŸ»

```txt
<type-specifier> ::= int | float | double | char | struct <identifier>

<struct-declaration> ::= struct <identifier> '{' <struct-member-declarations> '}'

<struct-member-declarations> ::= <struct-member-declaration> | <struct-member-declarations> <struct-member-declaration>

<struct-member-declaration> ::= <type-specifier> <declarator> ';'

<declarator> ::= <identifier> | <declarator> '[' <constant-expression> ']'

<constant-expression> ::= <integer-constant>

<statement> ::= <expression-statement> | ...

<expression-statement> ::= <expression> ';'

<expression> ::= <assignment-expression> | ...

<assignment-expression> ::= <conditional-expression> | <unary-expression> <assignment-operator> <assignment-expression>

<unary-expression> ::= <postfix-expression> | ...

<postfix-expression> ::= <primary-expression> | <postfix-expression> '.' <identifier>

<primary-expression> ::= <identifier> | <constant> | ...

<assignment-operator> ::= '='

<constant> ::= <integer-constant>

<integer-constant> ::= <digit>+

<digit> ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
```

è¯­ä¹‰åˆ†æç¨‹åº

```cpp
#define MAX_SYMBOLS 1000

typedef struct {
    char name[32];
    int type;
    int size;
    int offset;
} symbol_t;

typedef struct {
    char name[32];
    symbol_t members[MAX_SYMBOLS];
    int num_members;
    int size;
} struct_symbol_t;

struct_symbol_t struct_table[MAX_SYMBOLS];
int num_structs = 0;

symbol_t symbol_table[MAX_SYMBOLS];
int num_symbols = 0;

int add_struct(char *name, symbol_t *members, int num_members) {
    struct_symbol_t struct_symbol;
    strcpy(struct_symbol.name, name);
    struct_symbol.num_members = num_members;
    struct_symbol.size = 0;
    for (int i = 0; i < num_members; i++) {
        struct_symbol.members[i] = members[i];
        struct_symbol.size += members[i].size;
    }
    struct_table[num_structs++] = struct_symbol;
    return 0;
}

struct_symbol_t *find_struct(char *name) {
    for (int i = 0; i < num_structs; i++) {
        if (strcmp(struct_table[i].name, name) == 0) {
            return &struct_table[i];
        }
    }
    return NULL;
}

int add_symbol(char *name, int type, int size) {
    symbol_t symbol;
    strcpy(symbol.name, name);
    symbol.type = type;
    symbol.size = size;
    symbol.offset = 0;
    for (int i = 0; i < num_symbols; i++) {
        symbol.offset += symbol_table[i].size;
    }
    symbol_table[num_symbols++] = symbol;
    return 0;
}

symbol_t *find_symbol(char *name) {
    for (int i = 0; i < num_symbols; i++) {
        if (strcmp(symbol_table[i].name, name) == 0) {
            return &symbol_table[i];
        }
    }
    return NULL;
}

int main() {
    symbol_t members[] = {
        {"x", INT, sizeof(int)},
        {"y", INT, sizeof(int)}
    };
    add_struct("point", members, 2);
    struct_symbol_t *struct_symbol = find_struct("point");
    printf("Struct size: %d\n", struct_symbol->size);
    add_symbol("p", STRUCT, struct_symbol->size);
    symbol_t *symbol = find_symbol("p");
    printf("Symbol size: %d\n", symbol->size);
    return 0;
}
```
