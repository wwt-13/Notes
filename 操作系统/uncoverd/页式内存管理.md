[toc]

# 页式内存管理

> 分区式存储管理最大的缺点是碎片问题严重，内存利用率低。究其原因，主要在于连续分配的限制，即它要求**每个作业在内存中必须占一个连续的分区**。

如果允许将一个进程分散的装入到许多不相邻的分区中，便可以充分地利用内存，而无需再进行“**紧凑**”

基于这一思想，产生了“非连续分配方式/离散分配方式”

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018192823376-1377353258.png)

分页存储管理的思想：==把内存分为一个个相等的小分区，再按照分区大小把进程拆分成一个个小部分==

分页式内存管理分类：实分页存储管理和虚分页存储管理

## 实分页式内存管理

> 实分页式存储最大的优点是内存利用率高，与目前流行的虚分页存储管理相比，具有实现简单，程序运行快的优点。目前，飞速发展的硬件制造技术使得物理内存越来越大，因此我们认为，实分页式存储管理将是一种最有发展前途的存储管理方式。

借助一个实例来进行理解

> 假设一个大型饭店，所有的客房都是标准的双人间，部分客房已经住进客人，现在又有一个旅游团要求入住。接待员统计了一下，对旅游团领队说：“贵团全体成员都能住下，两人一个房间，但是不能住在同一楼层了，因为每层空着的客房不够，更没有几个挨着的。请原谅！”。对于这样的安排，一般人不会感到奇怪。因为旅游团本来就是由一位位个人或夫妻等组成的，而饭店的客房本来也是两人一间的，两人一组正好可住在一个客房里；另外，饭店几乎每天都有入住的和退房的客人，想在同一楼层找几间挨着的客房实在不容易。

1. 将整个系统的==内存空间==划分为一系列**大小相等的块**，每一块成为一个**物理块**、**物理页**、**页框**、**页帧**，可以简称为**块**，所有的块按照==物理地址==递增的顺序连续编号为0、1、2、3......

   $这里的块相当于饭店的客房，系统对内存分块相当于饭店把大楼所有的客房都设计成标准的双人间。$

2. 每个作业的==地址空间==也划分为一系列与内存块一样大小的块，每一块称为一个**逻辑页**或者**虚页**，可简称为**页**，所有的页按照==逻辑地址==递增的顺序连续编号为0、1、2、3......

   $这里，对作业地址空间分页就相当于把旅游团成员分成两人一组。$

3. 一个作业，只要它的总页数不大于内存中的可用块数，系统就可以对它实施分配。系统装入作业时，以页为单位分配内存，一页分配一个块，作业所有的页所占的块可以不连续。系统同时为这个作业建立一个页号与块号的对照表，称为**页表**。

   $这就像饭店有个记录客户入住情况的客户登记表一样。\\另外，饭店安排客户入住是要查看全部客房的使用情况一览表，\\相应地系统给作业分配内存时要查看主存分配表或者内存块说明表。$

   <img src="https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018194600358-1660106815.png" alt="img" style="zoom:67%;" />

4. 每个块的大小是固定的，一般是个1/2KB～==4KB==之间的数值（不能太大也不能太小，如果饭店中所有客房都是单人间或者10人间的话，效益坑定不如双人间好）

**实模式下分页存储管理的基本原理：**
操作系统**以页框为单位为各个进程分配内存空间**。系统自动地将作业的地址空间分页，将系统的主存空间分块，页与块等大小，在作业运行时，一次性把作业的全部页面装入内存，**各个页所占的内存块可以不连续，也不必按先后顺序，可以放到不相邻的各个页框中**。
这实际是个把作业从地址空间映射到存储空间的过程

> 属于纯分页系统，必须一次性的把作业的所有页撞到主存的页框中，如果当时的页框数目不足，则该作业必须等待，系统再另行调度其他作业。
>
> **优点**：
>
> 1. 不存在外碎片，且内碎片大小不会超过页大小（4KB）
> 2. 程序不必连续存放，便于改变程序占用空间的大小（主要指随着程序运行而动态生成的数据增多，要求地址空间相应增长，*通常由系统调用完成而不是操作系统自动完成*）
>
> **缺点**：程序全部装入内存

### 页表

> ==以32位系统，页表大小为4KB为例==
>
> 页面的划分完全是一种系统硬件的行为，一个逻辑地址放在这种地址结构里，自然的就分成了页号（20位）和页内单元（12位）两部分
>
> ![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018195200361-338382947.png)

在分页系统中，允许将作业（进程）的任一页装入到内存中的任一可用的物理块中，但进程的地址空间本来是连续的，若把他分页后装入到不相邻的物理块中，要保证系统仍能正确运行，就要<font color='red'>实现从进程的逻辑地址变换为内存的物理地址</font>。

所以，操作系统为每一个进行建立一张页面映射表，简称为**页表**。

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018195306625-957350329.png)

### 地址映射

> 在操作系统中设置地址变换机构，能够将**用户进程空间中的逻辑地址**转换为**内存空间的物理地址**（就是内存块和进程页如何对应的问题）
>
> Plus：由于页面和物理块的大小相等，页内偏移地址和块内偏移地址是相同的。无须进行从页内地址到块内地址的转换。

***页表的作用就是从页号到物理块号的转换，所以地址变换的任务需要借助于页表来完成。***

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018195750465-1261971848.png)

如果以十进制表示逻辑地址：

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018200032591-1181733382.png)

例题1：有一系统采用页式存储管理，有一作业大小是8KB，页大小为2KB，依次装入内存的第7、9、10、5块，试将虚地址7145，3412转换成内存地址。

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018200528308-1125651167.png)

 

**虚地址 3412**
   P＝3412 ％ 2048＝1

  W＝3412 mod 2048＝1364
   MA=9*2048+1364=19796
   虚地址3412的内存地址是19796


**虚地址 7145**
   P＝7145 ％ 2048 ＝3
   W＝7145 mod 2048 ＝1001
   MA=5*2048+1001=11241
   虚地址7145的内存地址是：11241

![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018200828027-107884583.png)

### 块表

> 因为页表是存放在内存中的，<u>CPU要存储一个数据，需要访问主存两次</u>
>
> 1. 访问内存中的页表，找到该页的物理块号，将此块号与页内地址拼接形成物理地址；
> 2. 真正访问物理地址，存取其中的内容‘
>
> 这样就使得程序的执行速度降低了一倍。
>
> 为了提高存储速度，==在地址变换机构中增设一组寄存器，用来存放访问的那些页表==（可以类比多级存储器的思想）

**快表是一种访存速度比内存快很多的高速缓冲器。**
**把存放在高速缓冲寄存器中的页表叫快表**，这个高速缓冲寄存器又叫**联想存贮器（TLB）。**与此对应，内存中的页表称为慢表。

**当进程访问一页时，系统将页号与快表中的所有项进行并行比较。若访问的页在快表中，即可立即进行地址转换。**
**当被访问的页不在快表中时，去内存中查询页表，==同时将页表找到的内存块号与虚页号填入快表中==**

例题：

快表命中率为98%，访问时间是10ns，内存访问时间是100ns，求平均访问时间？

平均访问时间=98%\*(10+100)+2%\*(10+100+100)=112ns

### 两级和多级页表

> 现代的大多数计算机系统，都支持非常庞大的逻辑地址空间，页表就会变得很大（如果逻辑地址空间有4T，页大小为4KB的话，~~就需要整整一个G大小的页表~~）
>
> 这时可以采用两种方法来解决这一问题：
>
> 1. 采用离散分配的方法来解决难以找到一块连续的大内存空间的问题（实际上并没有减少存储空间的大小，只是将存放的地方离散化了）
> 2. 只将当前需要的部分页表项调入内存，其余的页表项仍驻留在磁盘上，需要时再调入。
>
> ![img](https://img2018.cnblogs.com/blog/1358881/201910/1358881-20191018203745482-676567389.png)
>
> 总结一下，就是层层套娃的思想。









