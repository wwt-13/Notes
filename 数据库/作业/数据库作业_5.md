## è¯¾æœ¬ç¬¬130é¡µç¬¬5é¢˜ 1~7å°é¢˜

![[CleanShot 2023-03-22 at 15.50.12.png|800]]
å»ºè¡¨æŒ‡ä»¤ğŸ‘‡ğŸ»

```sql
create table if not exists S(
	Sno varchar(10),
	Sname varchar(10),
	Status int,
	city varchar(10),
	primary key(Sno)
);
create table if not exists P(
	Pno varchar(10),
	Pname varchar(10),
	color varchar(10),
	weight int,
	primary key(Pno)
);
create table if not exists J(
	Jno varchar(10),
	Jname varchar(10),
	city varchar(10),
	primary key(Jno)
);
create table if not exists SPJ(
	Sno varchar(10),
	Pno varchar(10),
	Jno varchar(10),
	Qty int,
	foreign key(Sno) references S(Sno),
	foreign key(Pno) references P(Pno),
	foreign key(Jno) references J(Jno)
);
```

æ•°æ®æ’å…¥

```sql
insert into S(Sno,Sname,Status,city)
values
('S1','ç²¾ç›Š',20,'å¤©æ´¥'),
('S2','ç››é”¡',10,'åŒ—äº¬'),
('S3','ä¸œæ–¹çº¢',30,'åŒ—äº¬'),
('S4','ä¸°æ³°ç››',20,'å¤©æ´¥'),
('S5','ä¸ºæ°‘',30,'ä¸Šæµ·');
insert into P(Pno,Pname,color,weight)
values
('P1','èºæ¯','çº¢',12),
('P2','èºæ “','ç»¿',17),
('P3','èºä¸åˆ€','è“',14),
('P4','èºä¸åˆ€','çº¢',14),
('P5','å‡¸è½®','è“',40),
('P6','é½¿è½®','çº¢',30);
insert into J(Jno,Jname,city)
values
('J1','ä¸‰å»º','åŒ—äº¬'),
('J2','ä¸€æ±½','é•¿æ˜¥'),
('J3','å¼¹ç°§å‚','å¤©æ´¥'),
('J4','é€ èˆ¹å‚','å¤©æ´¥'),
('J5','æœºè½¦å‚','å”å±±'),
('J6','æ— çº¿ç”µå‚','å¸¸å·'),
('J7','åŠå¯¼ä½“å‚','å—äº¬');
insert into SPJ(Sno,Pno,Jno,Qty)
values
('S1','P1','J1',200),
('S1','P1','J3',100),
('S1','P1','J4',700),
('S1','P2','J2',100),
('S2','P3','J1',400),
('S2','P3','J2',200),
('S2','P3','J4',500),
('S2','P3','J5',400),
('S2','P5','J1',400),
('S2','P5','J2',100),
('S3','P1','J1',200),
('S3','P3','J1',200),
('S4','P5','J1',100),
('S4','P6','J3',300),
('S4','P6','J4',200),
('S5','P2','J4',100),
('S5','P3','J1',200),
('S5','P6','J2',200),
('S5','P6','J4',500);
```

å»ºè¡¨å’Œæ•°æ®å‡æ’å…¥æˆåŠŸğŸ‘‡ğŸ»
![[CleanShot 2023-03-22 at 16.37.49.png]]
![[CleanShot 2023-03-22 at 16.37.39.png]]

1. æ‰¾å‡ºæ‰€æœ‰ä¾›åº”å•†çš„å§“åå’Œæ‰€åœ¨åŸå¸‚
   ```sql
   select Sname,city
   from S;
   ```
2. æ‰¾å‡ºæ‰€æœ‰é›¶ä»¶çš„åç§°ã€é¢œè‰²ã€é‡é‡
   ```sql
   select Pname,coloc,weight
   from P;
   ```
3. æ‰¾å‡ºä½¿ç”¨ä¾›åº”å•†S1æ‰€ä¾›åº”é›¶ä»¶çš„å·¥ç¨‹å·ç 
   ```sql
   select Pno
   from P 
   where Pno in(
       select Pno from SPJ where Sno='S1'
   );
   ```
4. æ‰¾å‡ºå·¥ç¨‹é¡¹ç›®J2ä½¿ç”¨çš„å„ç§é›¶ä»¶çš„åç§°åŠå…¶æ•°é‡
   ```sql
   select Pname,sum(Qty)
   from SPJ natural join J
   group by Pname; 
   ```
5. æ‰¾å‡ºä¸Šæµ·å‚å•†ä¾›åº”çš„æ‰€æœ‰é›¶ä»¶å·ç 
   ```sql
   select distinct Pno 
   from SPJ natural join S
   where city='ä¸Šæµ·';
   ```
6. æ‰¾å‡ºä½¿ç”¨ä¸Šæµ·äº§çš„é›¶ä»¶çš„å·¥ç¨‹å·ç 
   ```sql
   select distinct Jno
   from SPJ natural join S
   where city='ä¸Šæµ·';
   ```
7. æ‰¾å‡ºæ²¡æœ‰ä½¿ç”¨å¤©æ´¥äº§çš„é›¶ä»¶çš„å·¥ç¨‹å·ç 
   ```sql
   select T1.Jno
   from (
       select distinct Jno
       from SPJ natural join S
   )T1 left join(
       select distinct Jno
       from SPJ natural join S
       where city='å¤©æ´¥' 
   )T2 on T1.Jno=T2.Jno
   where T2.Jno is NULL;
   ```

ä½¿ç”¨åˆ°çš„æ•°æ®åº“è„šæœ¬ğŸ‘‡ğŸ»
![[create.sql]]

![[insert.sql]]

## SQLç»ƒä¹ 

### å­¦ç”Ÿé€‰è¯¾1

> å…³ç³»æ¨¡å¼ç®€åŒ–å¦‚ä¸‹ï¼š
> Stu(Sno,Sname,Sage,Sex)
> C(Cno,Cname,Tname)
> SC(Cno,Sno,Grade)

å»ºè¡¨è„šæœ¬+æ•°æ®æ’å…¥ğŸ‘‡ğŸ»

> [!hint]
> æ­¤æ•°æ®ä¸ºchat-gpt3.5-localéšæœºç”Ÿæˆ

```sql
create table Stu(
	Sno int auto_increment,
	Sname char(20),
	Sage int default(18),
	Ssex enum('male','female'),
	primary key(Sno)
);
create table C(
	Cno int auto_increment,
	Cname char(20),
	Tname char(20),
	primary key(Cno)
);
create table SC(
	Cno int,
	Sno int,
	Grade int,
	foreign key(Cno) references C(Cno),
	foreign key(Sno) references Stu(Sno)
);
insert into Stu (Sname, Sage, Sex)
values
    ('John', 20, 'M'),
    ('Jane', 22, 'F'),
    ('Bob', 19, 'M'),
    ('Alice', 21, 'F'),
    ('Tom', 20, 'M'),
    ('Mary', 23, 'F'),
    ('David', 22, 'M'),
    ('Susan', 20, 'F'),
    ('Mike', 21, 'M'),
    ('Emily', 19, 'F');

insert into C (Cname, Tname)
values
    ('Math', 'Johnson'),
    ('English', 'Smith'),
    ('History', 'Brown'),
    ('Chemistry', 'Wilson'),
    ('Physics', 'Davis'),
    ('Biology', 'Miller'),
    ('Art', 'Taylor'),
    ('Music', 'Anderson'),
    ('Physical Education', 'Thomas'),
    ('Computer Science', 'Clark');

insert into SC (Sno, Cno, Grade)
values
    (1, 1, 90),
    (1, 2, 85),
    (2, 3, 92),
    (2, 4, 88),
    (3, 5, 80),
    (3, 6, 75),
    (4, 7, 95),
    (4, 8, 90),
    (5, 9, 85),
    (5, 10, 80),
    (6, 1, 92),
    (6, 3, 90),
    (7, 5, 87),
    (7, 7, 95),
    (8, 9, 80),
    (8, 10, 85),
    (9, 2, 90),
    (9, 4, 92),
    (10, 6, 85),
    (10, 8, 90);
# å› ä¸ºåé¢è¦æŸ¥è¯¢é€‰ä¿®æ‰€æœ‰è¯¾çš„Sno
insert into SC(Sno,Cno,Grade)
values
	(1,3,40),
	(1,4,50),
	(1,5,60),
	(1,6,90),
	(1,7,20),
	(1,8,100),
	(1,9,60),
	(1,10,70);
```

![[CleanShot 2023-03-25 at 16.13.17.png]]

1. æ£€ç´¢å¹´é¾„å¤§äº 20 å²çš„ç”·ç”Ÿçš„å­¦å·å’Œå§“å
   ```sql
   select Sno,Sname
   from Stu
   where Sage>20 and Ssex='M';
   ```
2. æ£€ç´¢é€‰ä¿®äº†å§“åˆ˜çš„è€å¸ˆæ‰€æ•™æˆçš„è¯¾ç¨‹çš„å¥³å­¦ç”Ÿçš„å§“å
   ```sql
   select Sname
   from Stu natural join SC natural join C
   where Ssex='F' and Tname like 'åˆ˜%';
   ```
3. æ£€ç´¢ææƒ³åŒå­¦ä¸å­¦çš„è¯¾ç¨‹çš„è¯¾ç¨‹å·å’Œè¯¾ç¨‹å
   ```sql
   # not inåšæ³•
   select distinct Cno,Cname
   from Stu natural join SC natural join C
   where Cno not in(
       select Cno 
       from Stu natural join SC
       where Sname='åˆ˜æƒ³'
   );
   # left joinåšæ³•(è¿˜æ˜¯æŠŠé—®é¢˜æƒ³å¤æ‚äº†)
   select T1.Cno,T1.Cname
   from (
       select distinct Cno,Cname
       from Stu natural join SC natural join C  
   ) T1 left join (
       select distinct Cno,Cname
       from Stu natural join SC natural join C
       where Sname='åˆ˜æƒ³'
   ) T2 on T1.Cno=T2.Cno
   where T2.Cno is NULL;
   ```
4. æ£€ç´¢è‡³å°‘é€‰ä¿®äº†ä¸¤é—¨è¯¾ç¨‹çš„å­¦ç”Ÿçš„å­¦å·
   ```sql
   select distinct SC.Sno
   from SC join SC as a
   on SC.Sno=a.Sno
   where SC.Cno!=a.Cno;
   ```
5. æ±‚åˆ˜è€å¸ˆæ‰€æ•™æˆè¯¾ç¨‹çš„æ¯é—¨è¯¾çš„å¹³å‡æˆç»©
   ```sql
   select Cno,avg(Grade)
   from C natural join SC
   where Tname like 'åˆ˜%'
   group by Cno;
   ```
6. å‡è®¾ä¸å­˜åœ¨é‡ä¿®çš„æƒ…å†µï¼Œè¯·ç»Ÿè®¡æ¯é—¨è¯¾çš„é€‰ä¿®äººæ•°(é€‰è¯¾äººæ•°è¶…è¿‡ä¸¤äººçš„è¯¾ç¨‹æ‰ç»Ÿè®¡)ã€‚ è¦æ±‚æ˜¾ç¤ºè¯¾ç¨‹å·å’Œäººæ•°ï¼ŒæŸ¥è¯¢ç»“æœæŒ‰äººæ•°é™åºæ’åˆ—ï¼Œè‹¥äººæ•°ç›¸åŒï¼ŒæŒ‰è¯¾ç¨‹å·å‡åºæ’åˆ—
   ```sql
   select Cno,count(*)
   from SC
   group by Cno
   having count(*)>=2 # å› ä¸ºé€‰è¯¾äººæ•°å‡ä¸º2äººæ‰€ä»¥ä¸ç”¨>äº†å…ˆ
   order by count(*) desc,Cno asc;
   ```
7. æ±‚å¹´é¾„å¤§äºæ‰€æœ‰å¥³ç”Ÿå¹´é¾„çš„ç”·ç”Ÿçš„å§“åå’Œå¹´é¾„
   ```sql
   select Sname,Sage
   from Stu
   where Ssex='M' and Sage>all(
       select Sage
       from Stu
       where Ssex='F'
   );
   ```
8. å‡å®šä¸å­˜åœ¨é‡ä¿®çš„æƒ…å†µï¼Œæ±‚é€‰ä¿®äº†æ‰€æœ‰è¯¾ç¨‹çš„å­¦ç”Ÿçš„å­¦å·å§“åã€‚(å¯ä»¥ä¸ç”¨ç›¸å…³å­æŸ¥è¯¢åš)
   ```sql
   # ä¸ä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢
   select Sno,count(*)
   from SC
   group by Sno
   having count(*)=(
       select count(*)
       from C
   );
   # ä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢
   # ä¸å­˜åœ¨è¿™æ ·çš„è¯¾ç¨‹ï¼Œå­¦ç”Ÿxæ²¡æœ‰é€‰ä¿®
   select Sno,Sname
   from Stu
   # æ­¤å†…å±‚æ˜¯æ‰€æœ‰xæ‰€åœ¨çš„è¡¨
   where not exists(
       select *
       from C
       # æœ€å†…å±‚æ˜¯xå…³ç³»æ‰€åœ¨çš„è¡¨
       where not exists(
    	   select *
    	   from SC
    	   where SC.Cno=C.Cno and SC.Sno=Stu.Sno
       )
   );
   ```
9. æŸ¥è¯¢é‡ä¿®æ¬¡æ•°åœ¨ 2 æ¬¡ä»¥ä¸Šçš„å­¦ç”Ÿå­¦å·ï¼Œè¯¾ç¨‹å·ï¼Œé‡ä¿®æ¬¡æ•°
   ```sql
   select *
   from (
       select Sno,count(*)
       from SC
       where Grade<=60
       group by Sno
       having count(*)>2  
   )T1 join (
       select Cno
       from SC
       where Grade<=60
   )T2;
   ```
10. æŸ¥è¯¢é‡ä¿®å­¦ç”Ÿäººæ•°æœ€å¤šçš„è¯¾ç¨‹å·ï¼Œè¯¾ç¨‹åï¼Œæ•™å¸ˆå§“å
    ```sql
    select Cno,Cname,Tname from
    (
        select Cno,count(*)
        from SC
        where Grade<=60
        group by Cno
        having count(*)=(
     	   select count(*)
     	   from SC
     	   where Grade<=60
     	   group by Cno
     	   order by count(*)
     	   LIMIT 1
        )
    )T natural join C;
    ```

> [!warning] å‡ºç°çš„é—®é¢˜æ€»ç»“
>
> 1. ä½¿ç”¨onçš„è¯å¿…é¡»æ˜¾å¼æŒ‡å®šjoinè¯­å¥
> 2. è¡¨é‡å‘½åç”¨as
> 3. is NULLè€Œä¸æ˜¯=NULL
> 4. Likeè¯­å¥ä¸è¦å’Œ=å¼„æ··
> 5. åå‘æŸ¥è¯¢ä½¿ç”¨not in(left joinä¹Ÿæ­£ç¡®ä½†æ˜¯å¤ªå¤æ‚äº†)
> 6. æ³¨æ„distinctçš„ä½¿ç”¨
> 7. å¤šè¡¨æŸ¥è¯¢ï¼Œæ³¨æ„selectä¸­åˆ—åéœ€è¦æ”¹ä¸º"è¡¨.åˆ—å"
> 8. whereè¯­å¥å’Œgroup byè¯­å¥çš„æ‰§è¡Œé¡ºåºé—®é¢˜
> 9. å¤šé‡æ’åºé¡ºåºçš„æŒ‡å®šè§„èŒƒ
> 10. å¦‚ä½•ä¸ºå¤šè¡¨è¿æ¥åçš„ç»“æœè¡¨æŒ‡å®šåˆ«å

### å­¦ç”Ÿé€‰è¯¾2

> å…³ç³»æ¨¡å¼ç®€åŒ–å¦‚ä¸‹ï¼š
> Stu(Sno,Sname,Sage,Sex,Sclass)
> C(Cno,Cname,Cpreno,Credit)
> SC(Sno,Cno,Tno,Grade)
> T(Tno,Tname)

åˆ›å»ºåˆ—è¡¨å¹¶æ’å…¥æ•°æ®ğŸ‘‡ğŸ»

```sql
-- Create the Stu table
CREATE TABLE Stu (
  Sno INT AUTO_INCREMENT PRIMARY KEY,
  Sname VARCHAR(50) NOT NULL,
  Sage INT NOT NULL,
  Sex VARCHAR(10) NOT NULL,
  Sclass VARCHAR(50) NOT NULL
);

-- Create the C table
CREATE TABLE C (
  Cno INT NOT NULL,
  Cname VARCHAR(50) NOT NULL,
  Cpreno INT,
  Credit INT NOT NULL,
  PRIMARY KEY (Cno)
);
-- Create the T table
CREATE TABLE T (
  Tno INT AUTO_INCREMENT PRIMARY KEY,
  Tname VARCHAR(50) NOT NULL
);

-- Create the SC table
CREATE TABLE SC (
  Sno INT NOT NULL,
  Cno INT NOT NULL,
  Tno INT NOT NULL,
  Grade INT NOT NULL,
  PRIMARY KEY (Sno, Cno, Tno),
  FOREIGN KEY (Sno) REFERENCES Stu(Sno),
  FOREIGN KEY (Cno) REFERENCES C(Cno),
  FOREIGN KEY (Tno) REFERENCES T(Tno)
);

-- Insert data into the Stu table
INSERT INTO Stu (Sname, Sage, Sex, Sclass) VALUES
  ('John', 20, 'M', 'Class A'),
  ('Mary', 21, 'F', 'Class B'),
  ('Tom', 19, 'M', 'Class A'),
  ('Susan', 22, 'F', 'Class B'),
  ('David', 20, 'M', 'Class C'),
  ('Julia', 19, 'F', 'Class C'),
  ('Alex', 21, 'M', 'Class A'),
  ('Olivia', 20, 'F', 'Class B'),
  ('Eric', 19, 'M', 'Class A'),
  ('Sophie', 21, 'F', 'Class C');

-- Insert data into the C table
INSERT INTO C (Cno, Cname, Cpreno, Credit) VALUES
  (101, 'Math', NULL, 3),
  (102, 'English', NULL, 2),
  (103, 'Science', 101, 4),
  (104, 'History', NULL, 3),
  (105, 'Geography', NULL, 2),
  (106, 'Art', NULL, 2),
  (107, 'Music', NULL, 2),
  (108, 'Physical Education', NULL, 1),
  (109, 'Computer Science', 101, 3),
  (110, 'Biology', 103, 4);

-- Insert data into the T table
INSERT INTO T (Tname) VALUES
  ('Mr. Smith'),
  ('Ms. Johnson'),
  ('Mr. Lee'),
  ('Ms. Chen'),
  ('Mr. Kim'),
  ('Ms. Park'),
  ('Mr. Rodriguez'),
  ('Ms. Garcia'),
  ('Mr. Wong'),
  ('Ms. Chan');

-- Insert data into the SC table
INSERT INTO SC (Sno, Cno, Tno, Grade) VALUES
  (1, 101, 1, 90),
  (1, 102, 2, 85),
  (2, 102, 3, 92),
  (3, 101, 1, 80),
  (3, 103, 4, 88),
  (4, 105, 5, 95),
  (4, 106, 6, 85),
  (5, 104, 7, 78),
  (6, 102, 8, 90),
  (7, 103, 9, 85),
  (1, 105, 8, 55),
  (2, 107, 4, 58),
  (3, 109, 6, 59),
  (4, 102, 7, 45),
  (5, 106, 3, 50),
  (6, 108, 5, 57),
  (7, 110, 2, 56),
  (8, 101, 1, 62),
  (9, 104, 3, 59),
  (10, 103, 9, 58);
```

1. æŸ¥æ‰¾æåŠ›çš„æ‰€æœ‰ä¸åŠæ ¼çš„è¯¾ç¨‹åç§°å’Œæˆç»©ï¼ŒæŒ‰æˆç»©é™åºæ’åˆ—
   ```sql
   select Cname,Grade
   from Stu natural join SC natural join C
   where Sname="æåŠ›" and Grade<=60
   order by Grade desc;
   ```
2. åˆ—å‡ºæ¯é—¨è¯¾çš„å­¦åˆ†ï¼Œé€‰ä¿®çš„å­¦ç”Ÿäººæ•°ï¼ŒåŠå­¦ç”Ÿæˆç»©çš„å¹³å‡åˆ†
   ```sql
   select T.Cno,T.num,T.avg,Credit from (
       select Cno,count(*) num,avg(Grade) avg
       from SC
       group by Cno
   )T natural join C;
   ```
3. é€‰å‡ºæ‰€ä¿®è¯¾ç¨‹æ€»å­¦åˆ†åœ¨10åˆ†ä»¥ä¸‹çš„å­¦ç”Ÿï¼ˆæ³¨ï¼šä¸åŠæ ¼çš„è¯¾ç¨‹æ²¡æœ‰å­¦åˆ†ï¼‰
   ```sql
   select Sno,sum(Grade*Credit/100)
   from SC natural join C
   where Grade>=60
   group by Sno
   having sum(Grade*Credit/100)<10;
   ```
4. é€‰å‡ºé€‰è¯¾é—¨æ•°æœ€å¤šçš„å­¦ç”Ÿå­¦å·åŠé€‰è¯¾æ•°é‡
   ```sql
   select Sno,count(*)
   from SC
   group by Sno
   having count(*)=(
       select count(*)
       from SC
       group by Sno
       order by count(*) desc
       LIMIT 1
   );
   ```
5. åˆ—å‡ºæ¯é—¨è¯¾çš„æœ€é«˜åˆ†åŠè·å¾—è¯¥åˆ†æ•°çš„å­¦ç”Ÿ
   ```sql
   select Cno,Sno,G from(
       select Cno,max(Grade) G
       from SC
       group by Cno
   )T natural join SC
   where Grade=G;
   ```
6. é€‰å‡ºç‰©ç†è¯¾å¾—åˆ†æ¯”æ‰€æœ‰ç”·å­¦ç”Ÿçš„ç‰©ç†è¯¾å¹³å‡åˆ†é«˜çš„å­¦ç”Ÿå§“å
   ```sql
   select Sname
   from Stu natural join SC natural join C
   where Sex='M' and Cname='Physical Education' and Grade>(
       select avg(Grade)
       from Stu natural join SC natural join C
       where Sex='M' and Cname='Physical Education'
   );
   ```
7. é€‰å‡ºä¿®ä¹ è¿‡ç‰©ç†è¯¾çš„ç›´æ¥å…ˆä¿®è¯¾çš„å­¦ç”Ÿ
   ```sql
   select Sno
   from SC
   where Cno in (
       select Cpreno
       from SC natural join C
       where Cname='Physical Education'
   );
   ```
8. é€‰å‡ºæœ‰ä¸¤é—¨ä»¥ä¸Šå…ˆä¿®è¯¾çš„è¯¾ç¨‹ï¼ˆåŒ…æ‹¬ç›´æ¥å…ˆä¿®è¯¾ã€é—´æ¥å…ˆä¿®è¯¾ï¼‰(ç”¨è¯¾ç¨‹è¡¨)
   ```sql
   # é€‰å‡ºç›´æ¥+é—´æ¥å…ˆä¿®è¯¾å¤§äºç­‰äº2é—¨çš„è¯¾ç¨‹+ç›´æ¥å…ˆä¿®è¯¾å°±å¤§äºç­‰äº2é—¨çš„è¯¾ç¨‹
   select T.Cno
   from C join (
       select Cno,Cpreno
       from C
       where Cpreno is not NULL
   ) T on C.Cno=T.Cpreno
   where C.Cpreno is not NULL
   union
   select Cno
   from C
   where Cpreno is not NULL
   group by Cno
   having count(*)>=2;
   ```

> [!warning] å‡ºç°çš„é—®é¢˜æ€»ç»“
>
> 1. unionçš„ä½¿ç”¨
> 2. ç¬¬å…«é¢˜åŒé‡æŸ¥æ‰¾çš„è¯­æ³•
> 3. å…³äºâ€˜æœ€â€™ç›¸å…³çš„æŸ¥æ‰¾æ–¹å¼
> 4. selectè¯­å¥ä¸­çš„æ•°å­¦è¿ç®—ä»¥åŠgroupåçš„æ•°å­¦è¿ç®—è§„åˆ™

![[SQLä½œä¸š.pdf]]
